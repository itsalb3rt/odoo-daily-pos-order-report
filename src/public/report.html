<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/flexboxgrid.css" />
    <link rel="stylesheet" href="./css/pico.css" />
    <title>Odoo - Report</title>
  </head>
  <body>
    <main class="container">
      <h1>Reporte de ordenes</h1>
      <div class="row">
        <div class="col-xs-12">
          <button style="width: auto">âŽ™ Imprimir</button>
        </div>
        <div class="col-xs-12 col-md-4">
          <input id="start-date" type="date" />
        </div>
        <div class="col-xs-12 col-md-4">
          <input id="end-date" type="date" />
        </div>
        <div class="col-xs-12 col-md-4">
          <button style="width: auto" id="fetch-data">
            ðŸ”Ž Obtener reporte
          </button>
        </div>
      </div>

      <div class="order-table-container">
        <table>
          <thead>
            <tr>
              <th>Referencia</th>
              <th>Fecha</th>
              <th>Efectivo</th>
              <th>Credito</th>
              <th>Nombre Cliente</th>
              <th>NCF</th>
            </tr>
          </thead>
          <tbody class="order-table-body"></tbody>
        </table>
      </div>
      <div>
        <h5>Total: <span id="total-amount"></span></h5>
      </div>
    </main>
    <script>
      const token = window.localStorage.getItem('token');

      var formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
      });

      formatDate = (newDate) => {
        let d = new Date(newDate);
        let ye = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(d);
        let mo = new Intl.DateTimeFormat('en', { month: 'numeric' }).format(d);
        let da = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(d);
        return `${da}/${mo}/${ye}`
      };

      document.querySelector('#start-date').value = new Date()
        .toISOString()
        .split('T')[0];
      document.querySelector('#end-date').value = new Date()
        .toISOString()
        .split('T')[0];

      document.querySelector('#fetch-data').addEventListener('click', () => {
        const startDate = document.querySelector('#start-date').value;
        const endDate = document.querySelector('#end-date').value;

        const getReportButton = document.querySelector('#fetch-data');
        getReportButton.setAttribute('aria-busy', true);

        fetch(`./api/orders?date_order=between:${startDate},${endDate}&limit=9999`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `${token}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const orderTableBody = document.querySelector('.order-table-body');
            orderTableBody.innerHTML = '';
            let total = 0;

            data.data.forEach((order) => {
              const orderRow = document.createElement('tr');
              orderRow.innerHTML = `
              <td>${order.name}</td>
              <td>${formatDate(order.date_order)}</td>
              <td>${formatter.format(Number(order.amount_total))}</td>
              <td>0</td>
              <td>${order.res_partner.name}</td>
              <td>${order.ncf || ''}</td>
            `;

              total += Number(order.amount_total);
              orderTableBody.appendChild(orderRow);
            });

            document.querySelector('#total-amount').textContent =
              formatter.format(total);
          })
          .finally(() => {
            getReportButton.removeAttribute('aria-busy');
          });
      });
    </script>
  </body>
</html>
